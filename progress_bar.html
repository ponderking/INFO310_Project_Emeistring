<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="utf-8">
    <title>eMeistring - Progress Bar for Individual Patients</title>
    <script type="text/javascript" src="d3/d3.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!--    <link rel="stylesheet" href="css/dashboard.css"> -->
</head>
<body>
<script>


    // progress-bar code:
    // Code partly based on: http://bl.ocks.org/vkuchinov/c43323186765cb14ddd292e71790f0ec

    // I start handling our patient data here:

    var colors = { green: '#4DC87F', lightGreen: '#D9F0E3', darkGreen: '#3B5C0A', blue: '#0808EC', white: '#FFFFFF', black: '#000000', teal: "#87ddb7"};
    var warning_colors = {low: '#C0EC83', low_middle: '#A7E074', middle: '#96CC39', middle_high: '#6BA32D', high: 'orange', very_high: 'red', undetermined: '#7F8389'}

    d3.json("http://localhost:8000/data/patient_data.json", function(data) {
        patient_id = window.localStorage.getItem('patient_id')

        // temporary solution
        var amount_of_modules = data.treatment_program.amount_of_modules
        var current_week = data.treatment_program.current_week
        module_data = data.modules
        var patient_data = []

        for (var i = 0; i < amount_of_modules; i++) {
            // console.log(data[i].patient_data[0].madrs_score);
            patient_data.push(module_data[i].patient_data[patient_id])
            // d3.select('body').append('p').text("madrs_score patient 1 (test):" + madrs_score);
        }

        var moduleIDs = [];
        for (var i = 1; i <= amount_of_modules+1; i++) {
            moduleIDs.push(i);
        }

        drawProgressBar(patient_data, moduleIDs, amount_of_modules, current_week)
        });


    function drawProgressBar(patient_data, moduleIDs, amount_of_modules, current_week) {
        var width = 960, height = 50, offset = 48;
        width += offset * 2;
        height += offset * 2;
        var dimensions = '' + 0 + ' ' + 0 + ' ' + width + ' ' + height;

        var svg = d3.select('body').append('svg')
            .attr('id', 'scene', true)
            .attr('preserveAspectRatio', 'xMinYMin meet')
            .attr('viewBox', dimensions)
            .classed('svg-content', true);

        stepWidth = (width - offset * 2) / (moduleIDs.length - 1),
            currentStep = '0';

        var progressBar = svg.append('g')
            .attr('transform', 'translate(' + offset + ',' + offset + ')')
            .style('pointer-events', 'visible');


        var progressBackground = progressBar.append('rect')
            .attr('fill', colors.black)
            .attr('height', 8)
            .attr('width', width - offset * 2)
            .attr('rx', 4)
            .attr('ry', 4);

        progressBar.selectAll('circle')
            .data(moduleIDs)
            .enter()
            .append('circle')
            .attr('id', function(d, i){ return 'module_' + i; })
            .attr('cx', function(d, i){ return i * stepWidth; })
            .attr('cy', 4)
            .attr('r', function(i) {
                if(i===amount_of_modules+1) {
                    return 35;
                }
                else {
                    return 20;
                }})
            .attr('fill', '#FFFFFF')
            .attr('stroke', function(d) {
                if(d > amount_of_modules) {
                    return colors.black
                }
                else {
                    madrs_score = patient_data[d-1].madrs_score
                    var color_type = calculate_warning_color(madrs_score);
                    return warning_colors[color_type];
                }
            })
            .attr('stroke-width', 6)
            .on("click", function(d){
                if (d > amount_of_modules) {
                    display_aggregate_information(patient_data, d)
                }
                else if (d > current_week) {
                    display_upcoming_information(patient_data, d)
                }
                else {
                    display_module_information(patient_data, d)
                }
                d3.select(this)
                    .attr("fill", colors.teal)
            })
            .on("mouseover", function(d, i) {
                d3.select(this)
                    .attr("fill", colors.teal)
            })
            .on("mouseout", function(d, i) {
                d3.select(this)
                    .attr("fill", colors.white);
                d3.select("#tooltip2").classed("hidden", true);
            });

        progressBar.selectAll('text')
            .data(moduleIDs)
            .enter()
            .append('text')
            .attr('id', function(d, i){ return 'label_' + i; })
            .attr('dx', function(d, i){ return i * stepWidth; })
            .attr('dy', 10)
            .attr('text-anchor', 'middle')
            .text(function(d, i) {
                if (i >= amount_of_modules) {
                    return "All";
                } else
                {
                    return i + 1;
                }})
            .on("click", function(d){
                if (d > amount_of_modules) {
                    display_aggregate_information(patient_data, d)
                }
                else if (d > current_week) {
                    display_upcoming_information(patient_data, d)
                }
                else {
                    display_module_information(patient_data, d)
                    // window.location = "progress_bar_single_module.html"
                }
            });

    }


        // This function will display visualizations of an individual module for the patient.
        // It will display when you click on any of the module circles at the top of the page.

        function display_module_information(patient_data, d) {
            // var width = 960, height = 50, offset = 150;
            // width += offset * 2;
            // height += offset * 2;
            // var dimensions = '' + 0 + ' ' + 0 + ' ' + width + ' ' + height;
            //
            // var svg = d3.select('body').append('svg')
            //     .attr('id', 'module_visualization' + d, true)
            //     .attr('preserveAspectRatio', 'xMinYMin meet')
            //     .attr('viewBox', dimensions)
            //     .classed('svg-content', true);


            d3.select('body').append('p').text('Patient Name: ' + patient_data[d].patient_name);
            d3.select('body').append('p').text('Madrs Score: ' + patient_data[d].madrs_score);
            d3.select('body').append('p').text('Activity: ' + patient_data[d].activity);
            d3.select('body').append('p').text('Completed: ' + patient_data[d].module_completion);

        }

        // This function will display visualizations of an aggregate module data for the patient.
        // It will display when you click the top right circle labeled "All".

        function display_aggregate_information(patient_data, d) {
            console.log("Not Implemented Yet.")

        }

        function display_upcoming_information(patient_data, d) {
            d3.select('body').append('p').text('This Module has not started yet.');

        }


        function calculate_warning_color(score) {
            // Temporary values to favour our data that is randomly generated:
            // Real ranges should be: 0-6, 7-11, 12-22, 23-29, 30-34 and 35-60 respectively.
            switch (true) {
                case score >= 0 && score <= 10:
                    return "low";
                case score >= 11 && score <= 20:
                    return "low_middle";
                case score >= 21 && score <= 30:
                    return "middle";
                case score >= 31 && score <= 40:
                    return "middle_high";
                case score >= 41 && score <= 50:
                    return "high";
                case score >= 51 && score <= 60:
                    return "very_high";
                case score === "N/A":
                    return "undetermined";
            }
        }

        // end of d3.json() callback

</script>
</body>
</html>




